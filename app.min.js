class PharmacyMap{constructor(){this.map=this.createLeafletMap(),this.userMarker=null,this.pharmacies=[],this.userPosition=null}createLeafletMap(){const e=L.map("map").setView([6.28,1.22],12);return L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'}).addTo(e),e}createUserMarker(e){const{latitude:t,longitude:a}=e.coords,s=L.latLng(t,a);this.userPosition=s;const i=L.marker(s,{icon:L.icon({iconUrl:"assets/images/red-marker-icon.png"})}).addTo(this.map);return i.bindPopup("Vous êtes ici").openPopup(),i}updateMarkerPosition(e){const{latitude:t,longitude:a}=e.coords,s=L.latLng(t,a);this.userPosition=s,this.userMarker&&(this.userMarker.setLatLng(s),this.map.panTo(s)),this.updateNearbyPharmacies()}addPharmacyMarker(e){const t=L.marker([e.lat,e.lon]).addTo(this.map);e.onDuty&&t.setIcon(greenIcon);const a=L.popup().setContent(`<h4>${e.name}</h4><p>${e.address}</p><p>${e.phone?e.phone:"Non disponible"}</p><p>${e.onDuty?'<span class="badge badge-success">De garde</span>':'<span class="badge badge-secondary">Pas de garde</span>'}</p><button class="btn btn-primary btn-sm" onclick="pharmacyMap.navigateTo(${e.lat}, ${e.lon})">Naviguer</button>`);t.bindPopup(a)}async fetchAndProcessData(e){const t=await fetch(e),a=await t.json();return Array.isArray(a)?a:[]}async createPharmacyMap(){try{const e=await fetch("data/filtered-data.json"),t=await e.json(),a="data/pharmacy_names.json",s=await this.fetchAndProcessData(a);this.pharmacies=t.map(e=>({...e,onDuty:!!s.find(({name:t})=>this.compareStrings(t,e.name))})),this.pharmacies.forEach(e=>this.addPharmacyMarker(e)),navigator.geolocation?navigator.geolocation.watchPosition(e=>{this.userMarker?this.updateMarkerPosition(e):this.userMarker=this.createUserMarker(e)},e=>{console.error("Error getting user location:",e)}):console.error("Geolocation is not supported by your browser")}catch(e){console.error("Erreur en chargeant les données de pharmacies",e)}}compareStrings(e,t){const a=e=>e.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");return a(e)===a(t)}calculateDistance(e,t,a,s){const i=6371,n=(a-e)*Math.PI/180,r=(s-t)*Math.PI/180,o=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 2*i*Math.atan2(Math.sqrt(o),Math.sqrt(1-o))}updateNearbyPharmacies(){if(!this.userPosition)return;const e=this.pharmacies.map(e=>({...e,distance:this.calculateDistance(this.userPosition.lat,this.userPosition.lng,e.lat,e.lon)})).sort((e,t)=>e.distance-t.distance).slice(0,5),t=document.getElementById("nearbyPharmacies");t&&(t.innerHTML=e.map(e=>`<div class="pharmacy-item ${e.onDuty?"on-duty":""}" onclick="pharmacyMap.navigateTo(${e.lat}, ${e.lon})"><strong>${e.name}</strong><br><small>${e.address}</small><br>Distance: ${e.distance.toFixed(2)} km<br>${e.onDuty?'<span class="badge badge-success">De garde</span>':'<span class="badge badge-secondary">Pas de garde</span>'}</div>`).join(""))}navigateTo(e,t){if(this.userPosition){const a=`https://www.google.com/maps/dir/?api=1&origin=${this.userPosition.lat},${this.userPosition.lng}&destination=${e},${t}`;window.open(a,"_blank")}else alert("Votre position n'est pas disponible. Veuillez activer la géolocalisation.")}}const greenIcon=L.icon({iconUrl:"assets/images/green-marker.png",iconSize:[41,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),pharmacyMap=new PharmacyMap;pharmacyMap.createPharmacyMap();